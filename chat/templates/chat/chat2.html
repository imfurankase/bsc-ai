{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSC AI - Chat Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }
        .chat-message {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        .file-upload-overlay {
            border: 2px dashed #e5e7eb;
            transition: all 0.2s;
        }
        .file-upload-overlay.drag-over {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        
        /* Mobile sidebar overlay */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Mobile sidebar */
        @media (max-width: 1023px) {
            #sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            #sidebar.active {
                transform: translateX(0);
            }
        }
        
        /* Ensure proper spacing on mobile */
        @media (max-width: 640px) {
            .suggestion-grid {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 overflow-hidden">
    <!-- Mobile sidebar overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay lg:hidden" onclick="closeSidebar()"></div>
    
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div id="sidebar" class="w-72 bg-white border-r border-gray-200 flex flex-col">
            <!-- Sidebar Header -->
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center justify-between mb-3 lg:hidden">
                    <h2 class="text-lg font-semibold text-gray-900">Conversations</h2>
                    <button onclick="closeSidebar()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <button id="newChatBtn" class="w-full bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg py-2.5 px-4 font-medium hover:from-red-600 hover:to-red-700 transition-all shadow-sm">
                    <span class="flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        New Chat
                    </span>
                </button>
            </div>

            <!-- Chat History -->
            <div class="flex-1 overflow-y-auto scrollbar-hide">
                <div class="p-2 space-y-1">
                    {% if conversations %}
                        {% for conv in conversations %}
                        <div class="recent-chat p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors group {% if current_conversation and current_conversation.id == conv.id %}bg-gray-100{% endif %}" 
                             onclick="loadConversation({{ conv.id }})">
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-gray-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">{{ conv.title|default:"New Chat" }}</p>
                                    <p class="text-xs text-gray-500 mt-0.5">{{ conv.updated_at|timesince }} ago</p>
                                </div>
                                {% if conv.chat_type == 'document' %}
                                <span class="px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-700 rounded flex-shrink-0">üìÑ</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-center py-8 text-sm text-gray-500 px-4">No conversations yet.<br>Start a new chat!</p>
                    {% endif %}
                </div>
            </div>

            <!-- Sidebar Footer -->
            <div class="p-4 border-t border-gray-200">
                <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 transition-colors">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center text-white font-semibold text-sm flex-shrink-0">
                        {{ request.user.username|first|upper }}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">{{ request.user.username }}</p>
                        <p class="text-xs text-gray-500 truncate">{{ request.user.email|default:"" }}</p>
                    </div>
                    <button onclick="handleLogout()" 
                            class="p-2 hover:bg-red-100 rounded-lg transition-all flex-shrink-0" 
                            title="Logout">
                        <svg class="w-4 h-4 text-gray-500 hover:text-red-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col bg-white">
            <!-- Header -->
            <div class="border-b border-gray-200 bg-white">
                <div class="flex items-center justify-between px-4 sm:px-6 py-3 sm:py-4">
                    <div class="flex items-center gap-2 sm:gap-3">
                        <button id="toggleSidebar" class="p-2 hover:bg-gray-100 rounded-lg transition-colors lg:hidden">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                        </button>
                        <h1 class="text-lg sm:text-xl font-semibold text-gray-900">BSC AI</h1>
                        <span id="chatModeBadge" class="hidden px-2 sm:px-3 py-1 text-xs font-medium rounded-full"></span>
                    </div>
                </div>
            </div>

            <!-- Chat Messages Area -->
            <div id="chatArea" class="flex-1 overflow-y-auto scrollbar-hide">
                <div class="max-w-3xl mx-auto px-3 sm:px-6 py-4 sm:py-8">
                    <!-- Welcome State -->
                    <div id="welcomeState" class="{% if messages %}hidden{% endif %} text-center py-8 sm:py-20">
                        <div class="w-12 h-12 sm:w-16 sm:h-16 bg-gradient-to-br from-red-400 to-red-600 rounded-2xl mx-auto mb-4 sm:mb-6 flex items-center justify-center">
                            <svg class="w-8 h-8 sm:w-10 sm:h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                        </div>
                        <h2 class="text-xl sm:text-3xl font-semibold text-gray-900 mb-2 sm:mb-3 px-4">How can I help you today?</h2>
                        <p class="text-sm sm:text-base text-gray-600 mb-6 sm:mb-8 px-4">Ask me anything or upload documents to analyze</p>
                        
                        <!-- Suggestion Cards -->
                        <div class="suggestion-grid grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 max-w-2xl mx-auto">
                            <button class="suggestion-card p-3 sm:p-4 border border-gray-200 rounded-xl hover:border-red-400 hover:bg-red-50 transition-all text-left group">
                                <div class="flex items-start gap-2 sm:gap-3">
                                    <svg class="w-4 h-4 sm:w-5 sm:h-5 text-gray-400 group-hover:text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                    </svg>
                                    <div>
                                        <p class="text-xs sm:text-sm font-medium text-gray-900 mb-0.5 sm:mb-1">Generate ideas</p>
                                        <p class="text-xs text-gray-500">For a new project or feature</p>
                                    </div>
                                </div>
                            </button>

                            <button class="suggestion-card p-3 sm:p-4 border border-gray-200 rounded-xl hover:border-red-400 hover:bg-red-50 transition-all text-left group">
                                <div class="flex items-start gap-2 sm:gap-3">
                                    <svg class="w-4 h-4 sm:w-5 sm:h-5 text-gray-400 group-hover:text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <div>
                                        <p class="text-xs sm:text-sm font-medium text-gray-900 mb-0.5 sm:mb-1">Analyze documents</p>
                                        <p class="text-xs text-gray-500">Upload and discuss your files</p>
                                    </div>
                                </div>
                            </button>

                            <button class="suggestion-card p-3 sm:p-4 border border-gray-200 rounded-xl hover:border-red-400 hover:bg-red-50 transition-all text-left group">
                                <div class="flex items-start gap-2 sm:gap-3">
                                    <svg class="w-4 h-4 sm:w-5 sm:h-5 text-gray-400 group-hover:text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                                    </svg>
                                    <div>
                                        <p class="text-xs sm:text-sm font-medium text-gray-900 mb-0.5 sm:mb-1">Write code</p>
                                        <p class="text-xs text-gray-500">In any programming language</p>
                                    </div>
                                </div>
                            </button>

                            <button class="suggestion-card p-3 sm:p-4 border border-gray-200 rounded-xl hover:border-red-400 hover:bg-red-50 transition-all text-left group">
                                <div class="flex items-start gap-2 sm:gap-3">
                                    <svg class="w-4 h-4 sm:w-5 sm:h-5 text-gray-400 group-hover:text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                    </svg>
                                    <div>
                                        <p class="text-xs sm:text-sm font-medium text-gray-900 mb-0.5 sm:mb-1">Learn something new</p>
                                        <p class="text-xs text-gray-500">Get explanations on any topic</p>
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Chat Messages Container -->
                    <div id="messagesContainer" class="space-y-4 sm:space-y-6 {% if not messages %}hidden{% endif %}">
                        {% for msg in messages %}
                        <div class="chat-message flex gap-2 sm:gap-4 items-start">
                            {% if msg.is_user_message %}
                            <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
                                <span class="text-xs sm:text-sm font-semibold text-gray-600">{{ request.user.username|first|upper }}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm sm:text-base text-gray-900 break-words">{{ msg.content|default:"" }}</p>
                            </div>
                            {% else %}
                            <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center flex-shrink-0">
                                <svg class="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm sm:text-base text-gray-900 break-words">{{ msg.content|default:"" }}</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                        
                        <!-- Show attached documents in conversation -->
                        {% if conversation_documents %}
                        <div class="flex gap-2 sm:gap-4 items-start">
                            <div class="w-7 h-7 sm:w-8 sm:h-8"></div>
                            <div class="flex-1 min-w-0">
                                <div class="bg-blue-50 border border-blue-200 rounded-xl p-3 sm:p-4">
                                    <div class="flex items-center gap-2 mb-2 sm:mb-3">
                                        <svg class="w-4 h-4 sm:w-5 sm:h-5 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                        <span class="text-xs sm:text-sm font-semibold text-blue-900">Documents in this chat</span>
                                    </div>
                                    <div class="space-y-2">
                                        {% for doc in conversation_documents %}
                                        <div class="flex items-center gap-2 sm:gap-3 bg-white rounded-lg p-2 sm:p-3 border border-blue-100">
                                            <div class="p-1.5 sm:p-2 bg-blue-100 rounded-lg flex-shrink-0">
                                                <svg class="w-4 h-4 sm:w-5 sm:h-5 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
                                                    <path d="M14 2v6h6M10 13h4M10 17h4M10 9h1"/>
                                                </svg>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-xs sm:text-sm font-medium text-gray-900 truncate">{{ doc.title|default:"Document"|escapejs }}</p>
                                                <p class="text-xs text-gray-500">{{ doc.file_type|upper|default:"FILE" }} &bull; {{ doc.uploaded_at|date:"M d, Y"|default:"Unknown date" }}</p>
                                            </div>
                                            {% if doc.processed %}
                                            <span class="text-xs text-green-600 flex items-center gap-1 flex-shrink-0">
                                                <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                </svg>
                                                <span class="hidden sm:inline">Ready</span>
                                            </span>
                                            {% else %}
                                            <span class="text-xs text-yellow-600 flex-shrink-0">Processing...</span>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-200 bg-white">
                <div class="max-w-3xl mx-auto px-3 sm:px-6 py-3 sm:py-4">
                    <!-- Uploaded Files Preview -->
                    <div id="filePreviewArea" class="hidden mb-2 sm:mb-3 flex flex-wrap gap-2"></div>

                    <div class="flex items-end gap-2 sm:gap-3">
                        <input type="file" id="fileInput" accept=".pdf,.docx,.txt" style="display: none;" onchange="handleFileSelect(event)" multiple>
                        <button onclick="document.getElementById('fileInput').click()" class="p-2 sm:p-2.5 hover:bg-gray-100 rounded-lg transition-colors flex-shrink-0" title="Attach file">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                            </svg>
                        </button>
                        <div class="flex-1 relative">
                            <textarea 
                                id="messageInput" 
                                rows="1" 
                                placeholder="Message BSC AI..." 
                                class="w-full px-3 sm:px-4 py-2.5 sm:py-3 pr-10 sm:pr-12 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent resize-none text-sm sm:text-base"
                                style="max-height: 200px;"
                            ></textarea>
                            <button id="sendBtn" class="absolute right-1.5 sm:right-2 bottom-1.5 sm:bottom-2 p-1.5 sm:p-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed">
                                <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">BSC AI can make mistakes. Please verify important information.</p>
                </div>
            </div>
        </div>
    </div>

<script>
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Sidebar toggle functions
    function openSidebar() {
        document.getElementById('sidebar').classList.add('active');
        document.getElementById('sidebarOverlay').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('sidebarOverlay').classList.remove('active');
        document.body.style.overflow = '';
    }

    // Toggle sidebar button
    document.getElementById('toggleSidebar').addEventListener('click', openSidebar);

    // Logout function
    function handleLogout() {
        if (confirm('Are you sure you want to logout?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/logout/';
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = getCookie('csrftoken');
            form.appendChild(csrfInput);
            
            document.body.appendChild(form);
            form.submit();
        }
    }

    // State
    let currentConversationId = {% if current_conversation %}{{ current_conversation.id }}{% else %}null{% endif %};
    let currentChatType = '{% if current_conversation %}{{ current_conversation.chat_type }}{% else %}general{% endif %}';
    let uploadedFiles = [];
    const userInitial = '{{ request.user.username|first|upper|default:"U" }}';
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    // Update badge on load
    window.addEventListener('load', () => {
        updateChatModeBadge();
        const container = document.getElementById('chatArea');
        container.scrollTop = container.scrollHeight;
    });

    // New chat button
    const newChatBtn = document.getElementById('newChatBtn');
    newChatBtn.addEventListener('click', () => {
        startNewChat();
        closeSidebar();
    });

    function startNewChat() {
        currentConversationId = null;
        currentChatType = 'general';
        uploadedFiles = [];
        
        document.getElementById('welcomeState').classList.remove('hidden');
        const messagesContainer = document.getElementById('messagesContainer');
        messagesContainer.innerHTML = '';
        messagesContainer.classList.add('hidden');
        
        document.getElementById('filePreviewArea').innerHTML = '';
        document.getElementById('filePreviewArea').classList.add('hidden');
        
        window.history.pushState({}, '', '/');
        updateChatModeBadge();
        enableMessageInput();
        messageInput.focus();
    }

    function updateChatModeBadge() {
        const chatModeBadge = document.getElementById('chatModeBadge');
        
        if (uploadedFiles.length > 0 || currentChatType === 'document') {
            const count = uploadedFiles.length || 0;
            chatModeBadge.textContent = `üìÑ ${count} Document${count !== 1 ? 's' : ''}`;
            chatModeBadge.className = 'px-2 sm:px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-700';
            chatModeBadge.classList.remove('hidden');
        } else {
            chatModeBadge.classList.add('hidden');
        }
    }

    // Input control functions
    function disableMessageInput() {
        messageInput.disabled = true;
        sendBtn.disabled = true;
        messageInput.placeholder = "‚è≥ Waiting for documents to process...";
    }

    function enableMessageInput() {
        const unprocessed = uploadedFiles.some(f => !f.processed);
        if (!unprocessed) {
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.placeholder = "Message BSC AI...";
        } else {
            disableMessageInput();
        }
    }

    // Poll document status
    function pollDocumentStatus(docInfo) {
        if (docInfo.processed) return Promise.resolve(true);

        return new Promise((resolve) => {
            const interval = setInterval(() => {
                fetch(`/document-status/${docInfo.document_id}/`, {
                    headers: { 'X-CSRFToken': getCookie('csrftoken') }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.processed) {
                        clearInterval(interval);
                        docInfo.processed = true;
                        const fileCard = document.getElementById(`file-${docInfo.document_id}`);
                        if (fileCard) {
                            const statusSpan = fileCard.querySelector('.status-badge');
                            if (statusSpan) {
                                statusSpan.className = 'status-badge text-xs text-green-600 flex items-center gap-1';
                                statusSpan.innerHTML = '<svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> <span class="hidden sm:inline">Ready</span>';
                            }
                        }
                        enableMessageInput();
                        resolve(true);
                    }
                })
                .catch(() => {
                    // Keep polling
                });
            }, 1500);
        });
    }

    // File handling
    function handleFileSelect(event) {
        const files = Array.from(event.target.files);
        files.forEach(file => uploadFile(file));
        event.target.value = '';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function uploadFile(file) {
        const fileType = file.name.split('.').pop().toLowerCase();
        if (!['pdf', 'docx', 'txt'].includes(fileType)) {
            alert('Unsupported file type. Please upload PDF, DOCX, or TXT files.');
            return;
        }

        const filePreviewArea = document.getElementById('filePreviewArea');
        filePreviewArea.classList.remove('hidden');
        
        const uploadingCard = document.createElement('div');
        uploadingCard.id = `uploading-${Date.now()}`;
        uploadingCard.className = 'flex items-center gap-2 bg-gray-100 rounded-lg p-2 text-xs sm:text-sm';
        uploadingCard.innerHTML = `
            <svg class="w-3 h-3 sm:w-4 sm:h-4 text-gray-500 animate-spin flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            <span class="text-gray-700 truncate">Uploading ${escapeHtml(file.name)}...</span>
        `;
        filePreviewArea.appendChild(uploadingCard);

        const formData = new FormData();
        formData.append('document', file);
        if (currentConversationId) {
            formData.append('conversation_id', currentConversationId);
        }

        fetch('/upload-inline/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            uploadingCard.remove();
            
            if (data.success) {
                if (data.conversation_id && !currentConversationId) {
                    currentConversationId = data.conversation_id;
                    currentChatType = 'document';
                    window.history.replaceState({}, '', `/conversation/${data.conversation_id}/`);
                }
                
                const docInfo = {
                    document_id: data.document_id,
                    title: data.title,
                    file_type: data.file_type,
                    processed: data.processed,
                };
                uploadedFiles.push(docInfo);
                currentChatType = 'document';
                
                const fileCard = document.createElement('div');
                fileCard.id = `file-${data.document_id}`;
                fileCard.className = 'flex items-center gap-2 bg-blue-50 border border-blue-200 rounded-lg p-2 text-xs sm:text-sm';
                fileCard.innerHTML = `
                    <svg class="w-3 h-3 sm:w-4 sm:h-4 text-blue-600 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
                        <path d="M14 2v6h6M10 13h4M10 17h4M10 9h1"/>
                    </svg>
                    <span class="flex-1 text-blue-900 font-medium truncate">${escapeHtml(data.title)}</span>
                    <span class="status-badge text-xs ${data.processed ? 'text-green-600' : 'text-yellow-600'} flex items-center gap-1 flex-shrink-0">
                        ${data.processed ? 
                            '<svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> <span class="hidden sm:inline">Ready</span>' : 
                            'Processing...'}
                    </span>
                    <button onclick="removeFile(${data.document_id})" class="text-blue-600 hover:text-blue-800 flex-shrink-0">
                        <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                `;
                filePreviewArea.appendChild(fileCard);
                
                showDocumentInChat(data);
                updateChatModeBadge();
                
                if (!data.processed) {
                    disableMessageInput();
                    pollDocumentStatus(docInfo);
                } else {
                    enableMessageInput();
                }
            } else {
                alert('Error: ' + (data.error || 'Failed to upload file'));
                enableMessageInput();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            uploadingCard.remove();
            alert('Error uploading file');
            enableMessageInput();
        });
    }

    function showDocumentInChat(docData) {
        const messagesContainer = document.getElementById('messagesContainer');
        messagesContainer.classList.remove('hidden');
        document.getElementById('welcomeState').classList.add('hidden');
        
        const statusText = docData.processed ? 
            '<span class="text-xs text-green-600">Ready for questions</span>' : 
            '<span class="text-xs text-yellow-600">Processing...</span>';

        const docCard = document.createElement('div');
        docCard.className = 'chat-message flex gap-2 sm:gap-4 items-start';
        docCard.innerHTML = `
            <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
                <span class="text-xs sm:text-sm font-semibold text-gray-600">${userInitial}</span>
            </div>
            <div class="flex-1 min-w-0">
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-3 sm:p-4 max-w-sm">
                    <div class="flex items-center gap-2 sm:gap-3">
                        <div class="p-1.5 sm:p-2 bg-blue-100 rounded-lg flex-shrink-0">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
                                <path d="M14 2v6h6M10 13h4M10 17h4M10 9h1"/>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs sm:text-sm font-medium text-blue-900 truncate">${escapeHtml(docData.title)}</p>
                            <p class="text-xs text-blue-700 mt-1">${escapeHtml(docData.file_type.toUpperCase())} document uploaded ${statusText}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(docCard);
        
        const chatArea = document.getElementById('chatArea');
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function removeFile(documentId) {
        uploadedFiles = uploadedFiles.filter(f => f.document_id !== documentId);
        
        const fileCard = document.getElementById(`file-${documentId}`);
        if (fileCard) {
            fileCard.remove();
        }
        
        if (uploadedFiles.length === 0) {
            currentChatType = 'general';
            document.getElementById('filePreviewArea').classList.add('hidden');
        }
        
        updateChatModeBadge();
        enableMessageInput();
        
        fetch(`/delete-document/${documentId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
    }

    function linkDocumentsToConversation(conversationId, documents) {
        documents.forEach(doc => {
            fetch('/link-document/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: new URLSearchParams({
                    'conversation_id': conversationId,
                    'document_id': doc.document_id
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    doc.needsLinking = false;
                }
            })
            .catch(error => {
                console.error('Error linking document:', error);
            });
        });
    }

    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    });

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    function sendMessage() {
        const unprocessed = uploadedFiles.some(f => !f.processed);
        if (unprocessed) {
            alert("‚è≥ Please wait: documents are still being processed.");
            return;
        }

        const message = messageInput.value.trim();
        if (!message && uploadedFiles.length === 0) return;

        messageInput.disabled = true;
        sendBtn.disabled = true;

        document.getElementById('welcomeState').classList.add('hidden');
        document.getElementById('messagesContainer').classList.remove('hidden');

        if (message) {
            addMessage(message, true);
        }
        messageInput.value = '';
        messageInput.style.height = 'auto';

        const aiContent = addMessage('', false);
        aiContent.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';

        const formData = new URLSearchParams();
        formData.append('message', message || 'Please analyze the uploaded documents');
        formData.append('chat_type', currentChatType);

        const url = currentConversationId 
            ? `/send/${currentConversationId}/` 
            : '/send/';

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData.toString()
        })
        .then(response => {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let aiResponse = '';
            let firstChunk = true;

            function processText({done, value}) {
                if (done) {
                    enableMessageInput();
                    messageInput.focus();
                    return;
                }

                const chunk = decoder.decode(value, {stream: true});
                const lines = chunk.split('\n');

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));

                            if (data.chunk) {
                                if (firstChunk) {
                                    aiContent.innerHTML = '';
                                    firstChunk = false;
                                }
                                aiResponse += data.chunk;
                                aiContent.textContent = aiResponse;

                                const chatArea = document.getElementById('chatArea');
                                chatArea.scrollTop = chatArea.scrollHeight;
                            }

                            if (data.done && data.conversation_id) {
                                if (!currentConversationId) {
                                    currentConversationId = data.conversation_id;
                                    
                                    const documentsToLink = uploadedFiles.filter(f => f.needsLinking);
                                    if (documentsToLink.length > 0) {
                                        linkDocumentsToConversation(currentConversationId, documentsToLink);
                                    }
                                    
                                    setTimeout(() => {
                                        window.location.href = `/conversation/${data.conversation_id}/`;
                                    }, 1000);
                                }
                            }
                        } catch (e) {
                            // Ignore
                        }
                    }
                });

                return reader.read().then(processText);
            }

            return reader.read().then(processText);
        })
        .catch(error => {
            console.error('Error:', error);
            aiContent.textContent = '‚ùå Error sending message';
            enableMessageInput();
        });
    }

    function addMessage(text, isUser) {
        const container = document.getElementById('messagesContainer');
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-message flex gap-2 sm:gap-4 items-start';
        
        if (isUser) {
            messageDiv.innerHTML = `
                <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
                    <span class="text-xs sm:text-sm font-semibold text-gray-600">${userInitial}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm sm:text-base text-gray-900 break-words">${escapeHtml(text)}</p>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm sm:text-base text-gray-900 break-words">${text}</p>
                </div>
            `;
        }
        
        container.appendChild(messageDiv);
        
        const chatArea = document.getElementById('chatArea');
        chatArea.scrollTop = chatArea.scrollHeight;
        
        return isUser ? null : messageDiv.querySelector('.flex-1 p');
    }

    document.querySelectorAll('.suggestion-card').forEach(card => {
        card.addEventListener('click', function() {
            const text = this.querySelector('.text-xs.font-medium, .text-sm.font-medium').textContent;
            messageInput.value = text;
            messageInput.focus();
        });
    });

    function loadConversation(conversationId) {
        window.location.href = `/conversation/${conversationId}/`;
        closeSidebar();
    }
</script>

</body>
</html>
